<!doctype html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>ESO Marker Detail</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 24px;
				line-height: 1.4;
				background: #1f2430;
				color: #e6e9ef;
			}
			.panel {
				border: 1px solid #3a4250;
				border-radius: 8px;
				padding: 16px;
				background: #2a303b;
			}
			textarea {
				width: 100%;
				box-sizing: border-box;
				background: #222833;
				border: 1px solid #485263;
				color: #e6e9ef;
				border-radius: 6px;
				padding: 10px;
			}
			button {
				cursor: pointer;
				border: 1px solid #4a5466;
				background: #343c4a;
				color: #e6e9ef;
				border-radius: 6px;
				padding: 8px 10px;
			}
			.muted {
				color: #aeb7c6;
			}
			.back-link {
				display: inline-block;
				margin-bottom: 12px;
				color: #b8c9e6;
				text-decoration: none;
			}
			.back-link:hover {
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<h1>ESO Marker Detail</h1>
		<a
			class="back-link"
			href="./index.html"
			>← Zurück</a
		>

		<section class="panel">
			<p><strong>Raidgruppe:</strong> <span id="groupName"></span></p>
			<p><strong>Raid:</strong> <span id="raidName"></span></p>
			<p><strong>Typ:</strong> <span id="type"></span></p>
			<p><strong>Version:</strong> <span id="version"></span></p>
			<button
				id="copyBtn"
				type="button">
				Marker kopieren
			</button>
			<span
				id="copyStatus"
				class="muted"></span>
			<p></p>
			<textarea
				id="markerString"
				rows="15"
				readonly></textarea>
		</section>

		<script src="../config.js"></script>
		<script>
			const API_BASE = window.APP_CONFIG?.API_BASE || '';

			if (!API_BASE) {
				throw new Error('API_BASE fehlt. Bitte config.js konfigurieren.');
			}

			const versionEl = document.getElementById('version');
			const groupNameEl = document.getElementById('groupName');
			const raidNameEl = document.getElementById('raidName');
			const typeEl = document.getElementById('type');
			const markerEl = document.getElementById('markerString');
			const copyBtn = document.getElementById('copyBtn');
			const copyStatus = document.getElementById('copyStatus');

			const params = new URLSearchParams(window.location.search);
			const markerId = params.get('id');

			if (!markerId) {
				copyStatus.textContent = 'Kein Marker angegeben.';
			} else {
				loadMarker(markerId);
			}

			async function loadMarker(id) {
				try {
					const [markerResponse, groupsResponse, raidsResponse] = await Promise.all([
						fetch(`${API_BASE}/api/markers/${encodeURIComponent(id)}`),
						fetch(`${API_BASE}/api/groups`),
						fetch(`${API_BASE}/api/raids`),
					]);

					const data = await markerResponse.json();
					const groupsData = await groupsResponse.json();
					const raidsData = await raidsResponse.json();

					if (!markerResponse.ok) {
						throw new Error(data.error || `HTTP ${markerResponse.status}`);
					}

					const marker = data.marker;
					const groups = groupsData.groups || [];
					const raids = raidsData.raids || [];

					const group = groups.find((item) => item.id === marker.groupId);
					const raid = raids.find((item) => item.id === marker.raidId);

					groupNameEl.textContent = group ? group.name : marker.groupId || 'Unbekannt';
					raidNameEl.textContent = raid ? raid.name : marker.raidId || 'Unbekannt';
					typeEl.textContent = marker.type || 'Unbekannt';
					versionEl.textContent = String(marker.version);
					markerEl.value = marker.markerString;

					const autoCopied = await copyText(marker.markerString);
					copyStatus.textContent = autoCopied
						? 'Automatisch in die Zwischenablage kopiert.'
						: 'Automatisches Kopieren nicht möglich. Bitte Button nutzen.';

					copyBtn.onclick = async () => {
						const ok = await copyText(marker.markerString);
						copyStatus.textContent = ok ? 'Kopiert.' : 'Kopieren fehlgeschlagen.';
					};
				} catch (error) {
					copyStatus.textContent = `Fehler beim Laden: ${error.message}`;
				}
			}

			async function copyText(text) {
				try {
					if (navigator.clipboard && navigator.clipboard.writeText) {
						await navigator.clipboard.writeText(text);
						return true;
					}
				} catch {}

				markerEl.focus();
				markerEl.select();
				markerEl.setSelectionRange(0, markerEl.value.length);

				try {
					return document.execCommand('copy');
				} catch {
					return false;
				}
			}
		</script>
	</body>
</html>
