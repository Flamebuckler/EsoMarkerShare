<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>ESO Marker Detail</title>
		<link
			rel="stylesheet"
			href="css/main.css" />
	</head>
	<body>
		<header class="site-header">
			<h1>ESO Marker Share</h1>
			<p>Share and manage your markers for ESO raids</p>
		</header>
		<main class="container">
			<section class="card details">
				<p class="card-title">Marker details</p>

				<div class="marker-row list">
					<div class="marker-row-label">Group:</div>
					<div id="groupName"></div>
				</div>

				<div class="marker-row list details">
					<div class="marker-row-label">Raid:</div>
					<div id="raidName"></div>
				</div>
				<div class="marker-row list details">
					<div class="marker-row-label">Type:</div>
					<div id="type"></div>
				</div>
				<div class="marker-row list details">
					<div class="marker-row-label">Version:</div>
					<div id="version"></div>
				</div>

				<div class="copy-button-container">
					<button
						id="copyBtn"
						type="button">
						Copy marker
					</button>
					<span id="copyStatus"></span>
				</div>

				<textarea
					id="markerString"
					rows="15"
					readonly></textarea>
			</section>
		</main>

		<script src="../config.js"></script>
		<script>
			const API_BASE = window.APP_CONFIG?.API_BASE || '';

			if (!API_BASE) {
				throw new Error('API_BASE missing. Please configure config.js.');
			}

			const versionEl = document.getElementById('version');
			const groupNameEl = document.getElementById('groupName');
			const raidNameEl = document.getElementById('raidName');
			const typeEl = document.getElementById('type');
			const markerEl = document.getElementById('markerString');
			const copyBtn = document.getElementById('copyBtn');
			const copyStatus = document.getElementById('copyStatus');

			const params = new URLSearchParams(window.location.search);
			const markerId = params.get('id');

			if (!markerId) {
				copyStatus.textContent = 'No marker specified.';
			} else {
				loadMarker(markerId);
			}

			async function loadMarker(id) {
				try {
					const [markerResponse, groupsResponse, raidsResponse] = await Promise.all([
						fetch(`${API_BASE}/api/markers/${encodeURIComponent(id)}`),
						fetch(`${API_BASE}/api/groups`),
						fetch(`${API_BASE}/api/raids`),
					]);

					const data = await markerResponse.json();
					const groupsData = await groupsResponse.json();
					const raidsData = await raidsResponse.json();

					if (!markerResponse.ok) {
						throw new Error(data.error || `HTTP ${markerResponse.status}`);
					}

					const marker = data.marker;
					const groups = groupsData.groups || [];
					const raids = raidsData.raids || [];

					const group = groups.find((item) => item.id === marker.groupId);
					const raid = raids.find((item) => item.id === marker.raidId);

					groupNameEl.textContent = group ? group.name : marker.groupId || 'Unknown';
					raidNameEl.textContent = raid ? raid.name : marker.raidId || 'Unknown';
					typeEl.textContent = marker.type || 'Unknown';
					versionEl.textContent = String(marker.version);
					markerEl.value = marker.markerString;

					const autoCopied = await copyText(marker.markerString);
					copyStatus.textContent = autoCopied
						? 'Automatically copied to clipboard.'
						: 'Auto copy unavailable; please use the button.';
					copyBtn.onclick = async () => {
						const ok = await copyText(marker.markerString);
						copyStatus.textContent = ok ? 'Copied.' : 'Copy failed.';
					};
				} catch (error) {
					copyStatus.textContent = `Error loading: ${error.message}`;
				}
			}

			async function copyText(text) {
				try {
					if (navigator.clipboard && navigator.clipboard.writeText) {
						await navigator.clipboard.writeText(text);
						return true;
					}
				} catch {}

				markerEl.focus();
				markerEl.select();
				markerEl.setSelectionRange(0, markerEl.value.length);

				try {
					return document.execCommand('copy');
				} catch {
					return false;
				}
			}
		</script>
	</body>
</html>
